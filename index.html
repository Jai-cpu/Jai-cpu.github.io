<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports</title>
    <style>
        a {
          color: red;
        }
        a:visited {
          color: green;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #222;
        }
        .report {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 10px;
        }
        .report h2 {
            margin: 0 0 10px;
        }
        .report p {
            margin: 5px 0;
        }
        .report-tags {
            background-color: #333;
            padding: 5px;
            border-radius: 5px;
        }
        .report-user {
            color: #007BFF;
        }
        .tags {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Reports</h1>
    <div id="report-container"></div>
    <div class="tags">
        <h2>Total Reports: <span id="total-reports">0</span></h2>
        <h3>Sorted Tags:</h3>
        <ul id="sorted-tags"></ul>
    </div>

    <script>
        async function loadReports() {
            const response = await fetch('report_data.json');
            const reports = await response.json();

            if (reports) {
                processReports(reports);
            } else {
                document.getElementById('report-container').innerHTML = '<p>No reports available.</p>';
            }
        }

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function humanizeTime(time) {
            const now = new Date();
            const date = new Date(time * 1000);
            const diff = Math.abs(now - date) / 1000;

            if (diff < 60) return `${Math.floor(diff)} seconds ago`;
            if (diff < 3600) return `${Math.floor(diff / 60)} minutes ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
            return `${Math.floor(diff / 86400)} days ago`;
        }

        function processReports(reports) {
            let totalReports = 0;
            let tagCounts = {};

            const reportContainer = document.getElementById('report-container');
            reportContainer.innerHTML = '';

            const processedReports = Object.keys(reports).map(reportUrl => {
                const report = reports[reportUrl];
                const reportTags = report.report_tags || {};
                const reason = report['reason(s)'] ? report['reason(s)'][0] : 'No reason provided';
                const latestReport = humanizeTime(report.latest_report);
                const earliestReport = humanizeTime(report.earliest_report);

                const totalTagsCount = Object.values(reportTags).reduce((sum, count) => sum + count, 0);

                Object.keys(reportTags).forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + reportTags[tag];
                });

                return {
                    url: reportUrl,
                    report_user: report.report_user || 'Unknown',
                    report_tags: reportTags,
                    reason: reason,
                    latest_report: latestReport,
                    earliest_report: earliestReport,
                    total_tags_count: totalTagsCount,
                };
            });

            processedReports.sort((a, b) => b.total_tags_count - a.total_tags_count);

            processedReports.forEach(report => {
                const reportElement = document.createElement('div');
                reportElement.classList.add('report');
                reportElement.innerHTML = `
                    <h2>Report URL: <a href="${escapeHTML(report.url)}" target="_blank">${escapeHTML(report.url)}</a></h2>
                    <p><strong>Reported by:</strong> <a href="#" class="report-user">${escapeHTML(report.report_user)}</a></p>
                    <p><strong>Tags:</strong> <span class="report-tags">${escapeHTML(JSON.stringify(report.report_tags))}</span></p>
                    <p><strong>Reason:</strong> ${escapeHTML(report.reason)}</p>
                    <p><strong>Latest Report:</strong> ${escapeHTML(report.latest_report)}</p>
                    <p><strong>Earliest Report:</strong> ${escapeHTML(report.earliest_report)}</p>
                `;
                reportContainer.appendChild(reportElement);
            });

            totalReports = Object.values(tagCounts).reduce((sum, count) => sum + count, 0);
            document.getElementById('total-reports').innerText = totalReports;

            const sortedTagsList = document.getElementById('sorted-tags');
            sortedTagsList.innerHTML = '';
            const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);
            sortedTags.forEach(([tag, count]) => {
                const li = document.createElement('li');
                li.textContent = `${tag}: ${count}`;
                sortedTagsList.appendChild(li);
            });
        }

        window.onload = loadReports;
    </script>
</body>
</html>
